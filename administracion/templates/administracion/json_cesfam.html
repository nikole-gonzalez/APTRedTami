{% extends 'base.html' %}

{% block title %}Descarga de Horarios por CESFAM{% endblock %}

{% block content %}
<h2>Descargar horarios agendados por CESFAM</h2>

<table class="table">
    <thead>
        <tr>
            <th>CESFAM</th>
            <th>Horas Agendadas</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody>
        {% for cesfam in cesfams %}
        <tr>
            <td>{{ cesfam.nombre_cesfam }}</td>
            <td>{{ cesfam.num_horas }}</td>
            <td>
                {% if cesfam.num_horas %}
                  <button class="button descargar-json"
                    data-id="{{ cesfam.id_cesfam }}"
                    data-nombre="{{ cesfam.nombre_cesfam|escapejs }}">
                    Descargar JSON
                  </button>
                {% else %}
                    <button class="button disabled" disabled>Descargar JSON</button>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="3">No hay CESFAM disponibles</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<section style="margin-top: 2em;">
    <a class="button" href="{% url 'opc_vis_agenda' %}">Volver</a>
</section>

<!-- Mensaje de éxito -->
<div id="mensaje-exito" style="display:none; margin-top:1em;" class="alert alert-success">
    El archivo se ha descargado con éxito.
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const botones = document.querySelectorAll(".descargar-json");
    botones.forEach(boton => {
      boton.addEventListener("click", () => {
        const id = boton.getAttribute("data-id");
        const nombre = boton.getAttribute("data-nombre");
        descargarArchivo(id, nombre);
      });
    });
  });

  function descargarArchivo(cesfamId, nombreCesfam) {
    const url = `/json_cesfam/${cesfamId}/`;

    const enlace = document.createElement("a");
    enlace.href = url;
    enlace.download = "";
    enlace.style.display = "none";
    document.body.appendChild(enlace);
    enlace.click();
    document.body.removeChild(enlace);

    const mensaje = document.getElementById("mensaje-exito");
    mensaje.innerText = `El archivo de "${nombreCesfam}" se ha descargado con éxito.`;
    mensaje.style.display = "block";
    setTimeout(() => {
      mensaje.style.display = "none";
    }, 5000);
  }
</script>

<style>
  .button.disabled {
    pointer-events: none;
    opacity: 0.6;
  }

  .alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    padding: 10px;
    border-radius: 8px;
    color: #155724;
  }
</style>
{% endblock %}